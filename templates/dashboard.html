{% extends "base.html" %}

{% block title %}Dashboard - Lightera UNDOKAI{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
<style>
    .stats-card {
        transition: transform 0.2s;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    .real-time-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        background-color: #28a745;
        border-radius: 50%;
        animation: blink 1s infinite;
    }
    
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
    }
    
    .new-checkin-row {
        animation: highlightNew 3s ease-in-out;
    }
    
    @keyframes highlightNew {
        0% { background-color: rgba(40, 167, 69, 0.3); }
        100% { background-color: transparent; }
    }
    
    .pending-indicator {
        animation: pendingPulse 2s ease-in-out infinite;
    }
    
    @keyframes pendingPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Skip to main content for accessibility -->
<a href="#main-content" class="sr-only-focusable">Pular para o conte칰do principal</a>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 id="main-content"><i class="fas fa-chart-bar" aria-hidden="true"></i> Dashboard - Tempo Real</h1>
        <p class="lead text-muted mb-0">Vis칚o geral do evento UNDOKAI</p>
    </div>
    <div class="d-flex align-items-center">
        <span class="real-time-indicator" aria-label="Indicador de tempo real"></span>
        <small class="text-muted ms-2">Atualiza칞칚o autom치tica a cada 30s</small>
        <button class="btn btn-sm btn-outline-primary ms-3 focus-ring" onclick="refreshDashboard()" aria-label="Atualizar dados manualmente">
            <i class="fas fa-sync" aria-hidden="true"></i> 
            <span class="d-none d-md-inline">Atualizar</span>
        </button>
        <a href="{{ url_for('admin_panel') }}" class="btn btn-sm btn-primary ms-2 focus-ring" 
           aria-label="Abrir painel administrativo">
            <i class="fas fa-cog" aria-hidden="true"></i>
            <span class="d-none d-md-inline">Admin</span>
        </a>
    </div>
</div>

<!-- Statistics Cards with Enhanced Design -->
<div class="row mb-4" role="region" aria-labelledby="stats-heading">
    <div class="col-12">
        <h2 id="stats-heading" class="sr-only">Estat칤sticas do Evento</h2>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card-enhanced bg-primary text-white h-100" role="button" tabindex="0" 
             onclick="focusSection('participants')" onkeypress="handleCardKeypress(event, 'participants')"
             aria-label="Total de participantes inscritos">
            <div class="card-body text-center">
                <i class="fas fa-users stats-icon" aria-hidden="true"></i>
                <div class="stats-value" id="total-participants" aria-live="polite">{{ stats.total_participants }}</div>
                <p class="card-text mb-1">Total de Participantes</p>
                <small class="text-light">Inscri칞칫es confirmadas</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card-enhanced bg-success text-white h-100" role="button" tabindex="0"
             onclick="focusSection('checkins')" onkeypress="handleCardKeypress(event, 'checkins')"
             aria-label="Total de check-ins realizados">
            <div class="card-body text-center">
                <i class="fas fa-check-circle stats-icon" aria-hidden="true"></i>
                <div class="stats-value" id="total-checkins" aria-live="polite">{{ stats.total_checkins }}</div>
                <p class="card-text mb-1">Check-ins Realizados</p>
                <small class="text-light">
                    <span id="attendance-percentage">{{ "%.1f"|format((stats.total_checkins / stats.total_participants * 100) if stats.total_participants > 0 else 0) }}%</span> do total
                </small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card-enhanced bg-warning text-white h-100 pending-indicator" role="button" tabindex="0"
             onclick="focusSection('pending')" onkeypress="handleCardKeypress(event, 'pending')"
             aria-label="Participantes aguardando check-in">
            <div class="card-body text-center">
                <i class="fas fa-clock stats-icon" aria-hidden="true"></i>
                <div class="stats-value" id="pending-checkins" aria-live="polite">{{ stats.pending_checkins }}</div>
                <p class="card-text mb-1">Aguardando Check-in</p>
                <small class="text-light">Ainda n칚o compareceram</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stats-card-enhanced bg-info text-white h-100" role="button" tabindex="0"
             onclick="focusSection('rate')" onkeypress="handleCardKeypress(event, 'rate')"
             aria-label="Taxa de presen칞a do evento">
            <div class="card-body text-center">
                <i class="fas fa-percentage stats-icon" aria-hidden="true"></i>
                <div class="stats-value" id="attendance-rate" aria-live="polite">
                    {{ "%.1f"|format((stats.total_checkins / stats.total_participants * 100) if stats.total_participants > 0 else 0) }}%
                </div>
                <p class="card-text mb-1">Taxa de Presen칞a</p>
                <small class="text-light">Percentual de comparecimento</small>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Section -->
<div class="quick-actions-grid mb-4" role="region" aria-labelledby="quick-actions-heading">
    <h2 id="quick-actions-heading" class="sr-only">A칞칫es R치pidas</h2>
    
    <div class="quick-action-card focus-ring" onclick="openScanner()" tabindex="0" 
         onkeypress="handleCardKeypress(event, 'scanner')" role="button"
         aria-label="Abrir scanner de QR Code">
        <i class="fas fa-qrcode icon" aria-hidden="true"></i>
        <span>Scanner QR</span>
    </div>
    
    <div class="quick-action-card focus-ring" onclick="openSearch()" tabindex="0"
         onkeypress="handleCardKeypress(event, 'search')" role="button"
         aria-label="Buscar participante por nome">
        <i class="fas fa-search icon" aria-hidden="true"></i>
        <span>Buscar</span>
    </div>
    
    <div class="quick-action-card focus-ring" onclick="exportData()" tabindex="0"
         onkeypress="handleCardKeypress(event, 'export')" role="button"
         aria-label="Exportar dados para Excel">
        <i class="fas fa-file-excel icon" aria-hidden="true"></i>
        <span>Exportar</span>
    </div>
    
    <div class="quick-action-card focus-ring" onclick="sendReport()" tabindex="0"
         onkeypress="handleCardKeypress(event, 'report')" role="button"
         aria-label="Enviar relat칩rio por email">
        <i class="fas fa-envelope icon" aria-hidden="true"></i>
        <span>Relat칩rio</span>
    </div>
</div>

<!-- Search Box for Mobile -->
<div class="mobile-search-container d-md-none mb-4">
    <input type="text" class="mobile-search-box" placeholder="游댌 Buscar participante..." 
           id="mobile-search" aria-label="Campo de busca de participantes">
    <div class="mt-2">
        <small class="text-muted">Dica: Digite nome, email ou departamento</small>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4" role="region" aria-labelledby="charts-heading">
    <div class="col-12">
        <h2 id="charts-heading" class="sr-only">Gr치ficos e Estat칤sticas</h2>
    </div>
    
    <div class="col-md-8">
        <div class="card enhanced-table">
            <div class="card-header">
                <h3 class="h6 mb-0"><i class="fas fa-chart-line" aria-hidden="true"></i> Check-ins por Hor치rio (Hoje)</h3>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="hourlyChart" aria-label="Gr치fico de check-ins por hor치rio"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card enhanced-table">
            <div class="card-header">
                <h3 class="h6 mb-0"><i class="fas fa-chart-pie" aria-hidden="true"></i> Status dos Participantes</h3>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="statusChart" aria-label="Gr치fico de status dos participantes"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Check-ins and System Status -->
<div class="row">
    <div class="col-md-8">
        <div class="card enhanced-table" id="checkins">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="h6 mb-0"><i class="fas fa-history" aria-hidden="true"></i> Check-ins Recentes</h3>
                <button class="btn btn-sm btn-outline-primary focus-ring" onclick="refreshRecentCheckins()"
                        aria-label="Atualizar lista de check-ins recentes">
                    <i class="fas fa-sync" aria-hidden="true"></i>
                    <span class="sr-only">Atualizar</span>
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" role="table" aria-label="Lista de check-ins recentes">
                        <thead>
                            <tr role="row">
                                <th scope="col">Hor치rio</th>
                                <th scope="col">Participante</th>
                                <th scope="col">Departamento</th>
                                <th scope="col" class="text-center">Dependentes</th>
                                <th scope="col">Esta칞칚o</th>
                            </tr>
                        </thead>
                        <tbody id="recent-checkins-tbody">
                            {% for checkin, participant in recent_checkins %}
                            <tr role="row">
                                <td>{{ checkin.checkin_time.strftime('%H:%M') }}</td>
                                <td>
                                    <div class="fw-bold">{{ participant.nome }}</div>
                                    <small class="text-muted">{{ participant.email }}</small>
                                </td>
                                <td>{{ participant.departamento or '-' }}</td>
                                <td class="text-center">
                                    {% if participant.dependents %}
                                        <span class="enhanced-badge bg-info" aria-label="{{ participant.dependents|length }} dependentes">
                                            {{ participant.dependents|length }}
                                        </span>
                                    {% else %}
                                        <span aria-label="Nenhum dependente">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="enhanced-badge bg-secondary" aria-label="Esta칞칚o {{ checkin.station }}">
                                        {{ checkin.station }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not recent_checkins %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <i class="fas fa-info-circle" aria-hidden="true"></i>
                                    Nenhum check-in realizado ainda
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Enhanced Actions Panel -->
        <div class="card enhanced-table mb-3">
            <div class="card-header">
                <h3 class="h6 mb-0"><i class="fas fa-bolt" aria-hidden="true"></i> Painel de Controle</h3>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('scanner') }}" class="btn btn-primary touch-button focus-ring">
                        <i class="fas fa-camera" aria-hidden="true"></i> Abrir Scanner
                    </a>
                    <a href="{{ url_for('checkin_search') }}" class="btn btn-warning touch-button focus-ring">
                        <i class="fas fa-search" aria-hidden="true"></i> Buscar Participante
                    </a>
                    <button class="btn btn-info touch-button focus-ring" onclick="exportData()">
                        <i class="fas fa-download" aria-hidden="true"></i> Exportar Dados
                    </button>
                    <button class="btn btn-success touch-button focus-ring" onclick="sendReport()">
                        <i class="fas fa-envelope" aria-hidden="true"></i> Enviar Relat칩rio
                    </button>
                    <a href="{{ url_for('admin_panel') }}" class="btn btn-dark touch-button focus-ring">
                        <i class="fas fa-cog" aria-hidden="true"></i> Painel Admin
                    </a>
                </div>
            </div>
        </div>
        
        <!-- System Status Panel -->
        <div class="card enhanced-table">
            <div class="card-header">
                <h3 class="h6 mb-0"><i class="fas fa-server" aria-hidden="true"></i> Status do Sistema</h3>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Conex칚o</span>
                    <span class="enhanced-badge status-checked-in" id="connection-status" aria-live="polite">
                        <i class="fas fa-wifi" aria-hidden="true"></i> Online
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>칔ltima Atualiza칞칚o</span>
                    <small class="text-muted" id="last-update" aria-live="polite">Agora</small>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Auto-refresh</span>
                    <span class="enhanced-badge status-checked-in">
                        <i class="fas fa-check" aria-hidden="true"></i> Ativo
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Scanner</span>
                    <span class="enhanced-badge status-checked-in">
                        <i class="fas fa-camera" aria-hidden="true"></i> Pronto
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Keyboard Shortcuts Help -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1000;">
    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#shortcutsModal"
            aria-label="Ver atalhos de teclado">
        <i class="fas fa-keyboard" aria-hidden="true"></i>
        <span class="d-none d-md-inline">Atalhos</span>
    </button>
</div>

<!-- Shortcuts Modal -->
<div class="modal fade" id="shortcutsModal" tabindex="-1" aria-labelledby="shortcutsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shortcutsModalLabel">
                    <i class="fas fa-keyboard" aria-hidden="true"></i> Atalhos de Teclado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Navega칞칚o</h6>
                        <ul class="list-unstyled">
                            <li><kbd>Alt</kbd> + <kbd>S</kbd> Scanner</li>
                            <li><kbd>Alt</kbd> + <kbd>B</kbd> Buscar</li>
                            <li><kbd>Alt</kbd> + <kbd>D</kbd> Dashboard</li>
                            <li><kbd>Alt</kbd> + <kbd>A</kbd> Admin</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>A칞칫es</h6>
                        <ul class="list-unstyled">
                            <li><kbd>Alt</kbd> + <kbd>E</kbd> Exportar</li>
                            <li><kbd>Alt</kbd> + <kbd>R</kbd> Relat칩rio</li>
                            <li><kbd>F5</kbd> Atualizar</li>
                            <li><kbd>Esc</kbd> Fechar modais</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-chart-line"></i> Check-ins por Hor치rio (Hoje)</h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-chart-pie"></i> Status dos Participantes</h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Check-ins and Quick Actions -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6><i class="fas fa-history"></i> Check-ins Recentes</h6>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshRecentCheckins()">
                    <i class="fas fa-sync"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Hor치rio</th>
                                <th>Participante</th>
                                <th>Departamento</th>
                                <th>Dependentes</th>
                                <th>Esta칞칚o</th>
                            </tr>
                        </thead>
                        <tbody id="recent-checkins-tbody">
                            {% for checkin, participant in recent_checkins %}
                            <tr>
                                <td>{{ checkin.checkin_time.strftime('%H:%M') }}</td>
                                <td>{{ participant.nome }}</td>
                                <td>{{ participant.departamento or '-' }}</td>
                                <td class="text-center">
                                    {% if participant.dependents %}
                                        <span class="badge bg-info">{{ participant.dependents|length }}</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ checkin.station }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not recent_checkins %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    Nenhum check-in realizado ainda
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Quick Actions -->
        <div class="card mb-3">
            <div class="card-header">
                <h6><i class="fas fa-bolt"></i> A칞칫es R치pidas</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('scanner') }}" class="btn btn-primary">
                        <i class="fas fa-camera"></i> Abrir Scanner
                    </a>
                    <a href="{{ url_for('checkin_search') }}" class="btn btn-warning">
                        <i class="fas fa-search"></i> Buscar Participante
                    </a>
                    <button class="btn btn-info" onclick="exportData()">
                        <i class="fas fa-download"></i> Exportar Dados
                    </button>
                    <button class="btn btn-success" onclick="sendReport()">
                        <i class="fas fa-envelope"></i> Enviar Relat칩rio
                    </button>
                </div>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-server"></i> Status do Sistema</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border rounded p-2 mb-2">
                            <i class="fas fa-database text-success"></i>
                            <small class="d-block">Banco de Dados</small>
                            <span class="badge bg-success">Online</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2 mb-2">
                            <i class="fas fa-wifi text-success"></i>
                            <small class="d-block">Conex칚o</small>
                            <span class="badge bg-success" id="connection-status">Online</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <i class="fas fa-envelope text-warning"></i>
                            <small class="d-block">Email</small>
                            <span class="badge bg-warning">Standby</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <i class="fas fa-clock text-info"></i>
                            <small class="d-block">칔ltima Atualiza칞칚o</small>
                            <span class="badge bg-info" id="last-update">Agora</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Refresh Notification -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="refresh-toast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-sync text-primary me-2"></i>
            <strong class="me-auto">Dashboard</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            Dados atualizados com sucesso!
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<script>
// Initialize charts with data
const hourlyData = {{ hourly_stats | tojson }};
const statsData = {
    total_participants: {{ stats.total_participants }},
    total_checkins: {{ stats.total_checkins }},
    pending_checkins: {{ stats.pending_checkins }}
};

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard(hourlyData, statsData);
    
    // Auto-refresh every 30 seconds
    setInterval(refreshDashboard, 30000);
    
    // Check connection status
    setInterval(checkConnectionStatus, 10000);
});

function exportData() {
    window.location.href = '/api/export/checkins';
}

function sendReport() {
    if (confirm('Enviar relat칩rio atual por email?')) {
        fetch('/api/send_report', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Relat칩rio enviado com sucesso!');
                } else {
                    alert('Erro ao enviar relat칩rio: ' + data.message);
                }
            });
    }
}

function checkConnectionStatus() {
    fetch('/health')
        .then(response => {
            const status = document.getElementById('connection-status');
            if (response.ok) {
                status.textContent = 'Online';
                status.className = 'badge bg-success';
            } else {
                status.textContent = 'Inst치vel';
                status.className = 'badge bg-warning';
            }
        })
        .catch(() => {
            const status = document.getElementById('connection-status');
            status.textContent = 'Offline';
            status.className = 'badge bg-danger';
        });
}
</script>
{% endblock %}
